<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Permuta de Serviço Oficial</title>
    <!-- Inclui o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importa a fonte Inter do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Inclui o Flatpickr para o seletor de datas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        
        /* Estilo para erro de validação */
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 1px #ef4444;
        }
        /* Animação para o alerta */
        #custom-alert {
            transition: opacity 0.3s ease-in-out;
        }

        /* Estilos para a impressão (Solução para Celular) */
        @media print {
            /* Esconde tudo na página, exceto o container de impressão */
            body > *:not(#print-content-container) {
                display: none !important;
            }
            /* Mostra e formata o container de impressão */
            #print-content-container {
                display: block !important;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- Modal de Alerta Customizado -->
    <div id="custom-alert" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-60 z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform transition-all scale-95 opacity-0" id="alert-box">
            <h3 class="text-xl font-bold text-gray-800 mb-3" id="alert-title"></h3>
            <p class="text-gray-600 mb-6" id="alert-message"></p>
            <button onclick="closeCustomAlert()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                OK
            </button>
        </div>
    </div>

    <!-- Container Principal do Formulário -->
    <div class="printable-form bg-white rounded-xl shadow-lg p-6 sm:p-8 md:p-10 max-w-4xl mx-auto">
        
        <!-- Cabeçalho para Tela -->
        <header class="text-center mb-8 no-print">
            <img src="https://i.ibb.co/Xr6X43nG/BRAS-O.png" alt="Brasão da Polícia Militar" class="mx-auto h-20 w-auto mb-4">
            <div>
                <h1 class="text-sm font-bold tracking-wider text-gray-500 uppercase">Polícia Militar do Maranhão</h1>
                <p class="text-xs text-gray-400">10º Batalhão - 2ª Companhia</p>
            </div>
            <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-800 mt-6">Formulário de Permuta de Serviço</h2>
            <p class="text-lg font-semibold text-gray-600 mt-2">TURIAÇU</p>
        </header>
        
        <!-- Seção de Identificação -->
        <fieldset class="mb-8">
            <legend class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 w-full">1. Identificação</legend>
            <!-- PM Substituído -->
            <div class="mb-6">
                <h3 class="text-md font-bold text-gray-700 mb-3">PM SUBSTITUÍDO (Quem sai do serviço)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="pmSubstituidoNome" class="text-sm font-medium text-gray-600 block mb-1">Nome:</label>
                        <select id="pmSubstituidoNome" class="w-full p-3 border border-gray-300 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 rounded-md"></select>
                        <p id="pmSubstituidoNomeWarning" class="text-xs text-red-500 mt-1 hidden">Campo obrigatório.</p>
                    </div>
                    <div>
                        <label for="pmSubstituidoIdentificacao" class="text-sm font-medium text-gray-600 block mb-1">ID (Matrícula):</label>
                        <input type="tel" id="pmSubstituidoIdentificacao" placeholder="Digite o ID" pattern="\d*" class="w-full p-3 border border-gray-300 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 rounded-md">
                        <p id="pmSubstituidoIdentificacaoWarning" class="text-xs text-red-500 mt-1 hidden">Campo obrigatório.</p>
                    </div>
                </div>
            </div>
            <!-- PM Substituto -->
            <div>
                <h3 class="text-md font-bold text-gray-700 mb-3">PM SUBSTITUTO (Quem entra no serviço)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="pmSubstitutoNome" class="text-sm font-medium text-gray-600 block mb-1">Nome:</label>
                        <select id="pmSubstitutoNome" class="w-full p-3 border border-gray-300 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 rounded-md"></select>
                        <p id="pmSubstitutoNomeWarning" class="text-xs text-red-500 mt-1 hidden">Campo obrigatório.</p>
                    </div>
                    <div>
                        <label for="pmSubstitutoIdentificacao" class="text-sm font-medium text-gray-600 block mb-1">ID (Matrícula):</label>
                        <input type="tel" id="pmSubstitutoIdentificacao" placeholder="Digite o ID" pattern="\d*" class="w-full p-3 border border-gray-300 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 rounded-md">
                        <p id="pmSubstitutoIdentificacaoWarning" class="text-xs text-red-500 mt-1 hidden">Campo obrigatório.</p>
                    </div>
                </div>
            </div>
        </fieldset>
        
        <!-- Seção de Datas -->
        <fieldset>
            <legend class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2 w-full">2. Datas da Permuta</legend>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6">
                <!-- Data do Serviço Permutado -->
                <div class="flex flex-col">
                    <label class="text-md font-bold text-gray-700 mb-2">DATA(S) DO SERVIÇO PERMUTADO:</label>
                    <p class="text-xs text-gray-500 mb-3">Escolha de 1 a 3 dias consecutivos no calendário.</p>
                    <input type="text" id="dateRangePicker" placeholder="Clique para selecionar as datas" class="w-full p-3 border border-gray-300 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 rounded-md cursor-pointer">
                    <p id="dateRangePickerWarning" class="text-xs text-red-500 mt-1 hidden">Campo obrigatório.</p>
                </div>
                <!-- Data do Pagamento -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-md font-bold text-gray-700">DATA(S) DO PAGAMENTO:</label>
                        <label class="flex items-center text-xs text-gray-600 cursor-pointer">
                            <input type="checkbox" id="noPagamentoCheckbox" class="form-checkbox h-4 w-4 rounded text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2">Não há pagamento</span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 mb-3">Se houver, selecione o período no calendário.</p>
                    <div id="pagamentoServicoFields" class="transition-opacity duration-300">
                         <input type="text" id="paymentDateRangePicker" placeholder="Clique para selecionar as datas de pagamento" class="w-full p-3 border border-gray-300 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 rounded-md cursor-pointer">
                         <p id="paymentDateRangePickerWarning" class="text-xs text-red-500 mt-1 hidden">A seleção de um período (início e fim) é obrigatória.</p>
                    </div>
                </div>
            </div>
        </fieldset>
        
        <!-- Botões de Ação -->
        <div class="no-print flex flex-col md:flex-row justify-center items-center gap-4 mt-10 pt-6 border-t">
            <button onclick="printForm()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>
                Gerar e Imprimir
            </button>
            <button onclick="signWithGovBr()" class="w-full md:w-auto bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                ir para GOV.BR
            </button>
        </div>
    </div>

    <!-- Container para o conteúdo de impressão -->
    <div id="print-content-container" class="hidden"></div>

    <script>
        // Garante que o script rode apenas depois que o HTML for completamente carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Configuração do Flatpickr
            flatpickr.localize(flatpickr.l10ns.pt);
            
            // Calendário para Serviço Permutado
            const datePicker = flatpickr("#dateRangePicker", {
                mode: "range",
                dateFormat: "d/m/Y",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        const [start, end] = selectedDates;
                        const diffTime = Math.abs(end - start);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays > 2) {
                            showCustomAlert('Limite Excedido', 'Você só pode selecionar um intervalo de até 3 dias consecutivos.');
                            instance.clear();
                        }
                    }
                    validateField('dateRangePicker', 'dateRangePickerWarning');
                }
            });

            // Calendário para Pagamento do Serviço
            const paymentDatePicker = flatpickr("#paymentDateRangePicker", {
                mode: "range",
                dateFormat: "d/m/Y"
            });

            // Lógica do checkbox "Não há pagamento"
            const noPagamentoCheckbox = document.getElementById('noPagamentoCheckbox');
            noPagamentoCheckbox.addEventListener('change', function() {
                const fields = document.getElementById('pagamentoServicoFields');
                const pickerInput = document.getElementById('paymentDateRangePicker');
                const warning = document.getElementById('paymentDateRangePickerWarning');

                if (this.checked) {
                    fields.classList.add('opacity-50', 'pointer-events-none');
                    paymentDatePicker.clear();
                    pickerInput.classList.remove('input-error');
                    warning.classList.add('hidden');
                } else {
                    fields.classList.remove('opacity-50', 'pointer-events-none');
                }
            });

            // Dados dos PMs
            const pmData = {
                "Cb Pm 626/14 Coriolano": "N/A", "Sd Pm 473/16 André": "849351", "Sd Pm 408/18 Ribeiro": "N/A",
                "Sd Pm 424/18 Rodrigues": "N/A", "Sd Pm 885/18 Albert": "N/A", "Sd Pm 502/22 Sales": "869293",
                "SD PM 572/22 Theodosio": "871896", "Sd Pm 457/24 Eduardo Silva": "869987"
            };
            
            // Popula as listas suspensas de nomes
            function populateNameDropdowns() {
                const substituidoSelect = document.getElementById('pmSubstituidoNome');
                const substitutoSelect = document.getElementById('pmSubstitutoNome');
                const selects = [substituidoSelect, substitutoSelect];

                selects.forEach(select => {
                    select.innerHTML = ''; // Limpa opções existentes

                    // Adiciona a opção padrão
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "-- Selecione um nome --";
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    select.appendChild(defaultOption);

                    // Adiciona os nomes do objeto pmData
                    for (const name in pmData) {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                    }
                });
            }
            
            // Preenchimento automático do ID ao selecionar um nome
            function setupNameSelection(nameSelect, idInput) {
                nameSelect.addEventListener('change', (event) => {
                    const selectedName = event.target.value;
                    idInput.value = pmData[selectedName] || '';
                    validateField(nameSelect.id, nameSelect.id + 'Warning');
                    validateField(idInput.id, idInput.id + 'Warning');
                });
            }
            
            // Inicializa as funções de preenchimento
            populateNameDropdowns();
            setupNameSelection(document.getElementById('pmSubstituidoNome'), document.getElementById('pmSubstituidoIdentificacao'));
            setupNameSelection(document.getElementById('pmSubstitutoNome'), document.getElementById('pmSubstitutoIdentificacao'));
        });

        // Funções globais (acessíveis via onclick)
        function showCustomAlert(title, message) {
            const alertContainer = document.getElementById('custom-alert');
            const alertBox = document.getElementById('alert-box');
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            alertContainer.classList.remove('hidden');
            setTimeout(() => {
                alertContainer.style.opacity = '1';
                alertBox.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        window.closeCustomAlert = function() {
            const alertContainer = document.getElementById('custom-alert');
            alertContainer.style.opacity = '0';
            document.getElementById('alert-box').classList.add('scale-95', 'opacity-0');
            setTimeout(() => alertContainer.classList.add('hidden'), 300);
        };

        function validateField(fieldId, warningId) {
            const field = document.getElementById(fieldId);
            const warning = document.getElementById(warningId);
            const isValid = field.value.trim() !== '';
            field.classList.toggle('input-error', !isValid);
            warning.classList.toggle('hidden', isValid);
            return isValid;
        }

        function validateAllFields() {
            let isValid = true;
            
            const fieldsToValidate = [
                { id: 'pmSubstituidoNome', warningId: 'pmSubstituidoNomeWarning' },
                { id: 'pmSubstituidoIdentificacao', warningId: 'pmSubstituidoIdentificacaoWarning' },
                { id: 'pmSubstitutoNome', warningId: 'pmSubstitutoNomeWarning' },
                { id: 'pmSubstitutoIdentificacao', warningId: 'pmSubstitutoIdentificacaoWarning' },
                { id: 'dateRangePicker', warningId: 'dateRangePickerWarning' }
            ];

            fieldsToValidate.forEach(field => {
                if (!validateField(field.id, field.warningId)) isValid = false;
            });
            
            if (!document.getElementById('noPagamentoCheckbox').checked) {
                const paymentPickerInput = document.getElementById('paymentDateRangePicker');
                const warning = document.getElementById('paymentDateRangePickerWarning');
                
                if (paymentPickerInput.value && paymentPickerInput._flatpickr && paymentPickerInput._flatpickr.selectedDates.length < 2) {
                    showCustomAlert('Erro de Validação', 'Para o pagamento, por favor, selecione um intervalo de datas completo, clicando na data de início e depois na de fim.');
                    paymentPickerInput.classList.add('input-error');
                    warning.classList.remove('hidden');
                    isValid = false;
                } else {
                    paymentPickerInput.classList.remove('input-error');
                    warning.classList.add('hidden');
                }
            }
            return isValid;
        }

        function formatarDataRangeImpressao(dateStrPt) {
            if (!dateStrPt || typeof dateStrPt !== 'string') return '';

            const parseDate = (dStr) => {
                const parts = dStr.trim().split('/');
                if (parts.length !== 3) return null;
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Mês é 0-indexado
                const year = parseInt(parts[2], 10);
                if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
                return new Date(year, month, day);
            };

            const dateParts = dateStrPt.split(' a ');
            const startDate = parseDate(dateParts[0]);
            
            if (!startDate) return '';

            const endDate = dateParts.length > 1 ? parseDate(dateParts[1]) : startDate;

            if (!endDate) return '';

            let allDates = [];
            let currentDate = new Date(startDate.getTime());
            
            while (currentDate <= endDate) {
                allDates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (allDates.length === 0) {
                return '';
            }

            if (allDates.length === 1) {
                return allDates[0].toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }

            const firstDate = allDates[0];
            const days = allDates.map(d => d.getDate().toString().padStart(2, '0')).join(' e ');
            const month = (firstDate.getMonth() + 1).toString().padStart(2, '0');
            const year = firstDate.getFullYear();
            
            return `${days}/${month}/${year}`;
        }

        function printForm() {
            if (!validateAllFields()) {
                showCustomAlert('Atenção!', 'Por favor, preencha todos os campos obrigatórios corretamente.');
                return;
            }
            
            const pmSubstituidoNome = document.getElementById('pmSubstituidoNome').value.toUpperCase();
            const pmSubstituidoId = document.getElementById('pmSubstituidoIdentificacao').value;
            const pmSubstitutoNome = document.getElementById('pmSubstitutoNome').value.toUpperCase();
            const pmSubstitutoId = document.getElementById('pmSubstitutoIdentificacao').value;
            const dateRange = document.getElementById('dateRangePicker').value;
            const paymentDateRange = document.getElementById('paymentDateRangePicker').value;
            
            // Lógica automática para "Não há pagamento"
            const noPagamento = document.getElementById('noPagamentoCheckbox').checked || !paymentDateRange;

            const localizacaoSede = '&nbsp;';
            const localizacaoTurilandia = '&nbsp;';
            const localizacaoTuriacu = 'X';
            
            const parseDateForCalc = (dStr) => {
                const parts = dStr.trim().split('/');
                if (parts.length !== 3) return null;
                return new Date(parts[2], parts[1] - 1, parts[0]);
            };

            const dates = dateRange.split(' a ');
            const startDate = parseDateForCalc(dates[0]);
            const endDate = dates.length > 1 ? parseDateForCalc(dates[1]) : startDate;
            let diasServico = 0;
            if (startDate && endDate) {
                diasServico = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            }
            
            const tipo24Horas = diasServico === 1 ? '☑' : '☐';
            const tipo48Horas = diasServico === 2 ? '☑' : '☐';
            const tipo72Horas = diasServico >= 3 ? '☑' : '☐';

            const servicoPermutadoTexto = formatarDataRangeImpressao(dateRange);
            const pagamentoServicoTexto = !noPagamento && paymentDateRange ? formatarDataRangeImpressao(paymentDateRange) : '';
            const pagamentoHtml = pagamentoServicoTexto ? `<p>Data do pagamento do serviço: ${pagamentoServicoTexto}</p>` : '';
            
            const brasaoUrlPrint = 'https://i.ibb.co/Xr6X43nG/BRAS-O.png';

            const printContent = `
                <div style="font-family: 'Times New Roman', Times, serif; margin: 1.5cm; line-height: 1.15; font-size: 12pt;">
                    <div style="text-align: center;">
                        <img src="${brasaoUrlPrint}" alt="Brasão" style="width: 100px; height: 120px; display: block; margin: 0 auto 5px;">
                        <p style="font-weight: bold; margin: 2px 0;">ESTADO DO MARANHÃO</p>
                        <p style="margin: 2px 0;">SECRETARIA DE SEGURANÇA PÚBLICA</p>
                        <p style="margin: 2px 0;">CPA/I-5 – 10º BPM</p>
                        <p style="margin: 2px 0;">10º BATALHÃO DA POLÍCIA MILITAR DO MARANHÃO</p>
                        <p style="margin: 2px 0;">2ª COMPANHIA DO 10° BATALHÃO DE POLÍCIA MILITAR</p>
                        <p style="font-size: 9pt; margin: 2px 0;">Rua Dr. Paulo Ramos, s/nº, Centro, Santa Helena - MA, Telefax: (98) 99243-6850 - Email: 2cia10bpm@gmail.com</p>
                        <p style="font-weight: bold; margin-top: 2rem; margin-bottom: 1rem;">FORMULÁRIO DE AUTORIZAÇÃO PARA PERMUTA DE SERVIÇO</p>
                    </div>
                    <p>SEDE: ( ${localizacaoSede} )&nbsp;&nbsp;&nbsp;&nbsp;DPM TURILÂNDIA: ( ${localizacaoTurilandia} )&nbsp;&nbsp;&nbsp;&nbsp;DPM TURIAÇU: ( ${localizacaoTuriacu} )</p>
                    <div style="margin-top: 1.5rem;">
                        <p>PM SUBSTITUÍDO: ${pmSubstituidoNome} - ID: ${pmSubstituidoId}</p>
                        <p style="margin-top: 3rem;">Assinatura:________________________________________</p>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <p>PM SUBSTITUTO: ${pmSubstitutoNome} - ID: ${pmSubstitutoId}</p>
                        <p style="margin-top: 3rem;">Assinatura:________________________________________</p>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <p>Data do serviço permutado: ${servicoPermutadoTexto}</p>
                        ${pagamentoHtml}
                    </div>
                    <div style="margin-top: 1rem;">
                        <p>${tipo24Horas} 24 Horas &nbsp;&nbsp; ${tipo48Horas} 48 Horas &nbsp;&nbsp; ${tipo72Horas} 72 Horas</p>
                    </div>
                    <div style="text-align: center; margin-top: 2.5rem;">
                        <p>AUTORIZO A PERMUTA ENTRE OS POLICIAIS MILITARES ACIMA RELACIONADOS: ( &nbsp; ) Sim ( &nbsp; ) Não</p>
                        <p style="margin-top: 3rem;">_____________________________________________________</p>
                        <p style="font-weight: bold;">JOSE RIBAMAR BRAGA JUNIOR - 1º TEN QOPM</p>
                        <p>COMANDANTE DA 2°CP/10°BPM</p>
                    </div>
                </div>`;
            
            document.getElementById('print-content-container').innerHTML = printContent;
            window.print();
        }
        
        function signWithGovBr() {
            window.open('https://sso.acesso.gov.br/login?client_id=assinador.iti.br&authorization_id=198daa71163', '_blank');
        }
    </script>
</body>
</html>
